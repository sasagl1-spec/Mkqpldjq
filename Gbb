# meta developer: @your_username
# meta pic: https://img.icons8.com/color/48/000000/advertisement.png
# meta license: MIT

import asyncio
import time
from datetime import datetime
from telethon.tl.types import Message

from .. import loader, utils

@loader.tds
class AdvertiserMod(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏ —Ä–µ–∫–ª–∞–º—ã –≤ —á–∞—Ç—ã"""
    
    strings = {
        "name": "Advertiser",
        "on": "‚úÖ <b>–†–∞—Å—Å—ã–ª–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</b>",
        "off": "‚ùå <b>–†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</b>",
        "stats": (
            "üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏:</b>\n"
            "‚Ä¢ –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–æ–∫: {}\n"
            "‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞: {}\n"
            "‚Ä¢ –°–ª–µ–¥—É—é—â–∞—è —á–µ—Ä–µ–∑: {} —Å–µ–∫.\n"
            "‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π –¥–æ —Å–ø–µ—Ü-—Ä–∞—Å—Å—ã–ª–∫–∏: {}/73"
        )
    }

    def __init__(self):
        self.config = loader.ModuleConfig(
            loader.ConfigValue(
                "delay_between_chats",
                16,
                "–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏ (—Å–µ–∫)",
                validator=loader.validators.Integer(minimum=5, maximum=60)
            ),
            loader.ConfigValue(
                "main_interval",
                607,
                "–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫)",
                validator=loader.validators.Integer(minimum=300, maximum=3600)
            ),
            loader.ConfigValue(
                "special_chat_delay",
                73,
                "–°–æ–æ–±—â–µ–Ω–∏–π –¥–æ —Å–ø–µ—Ü-—Ä–∞—Å—Å—ã–ª–∫–∏",
                validator=loader.validators.Integer(minimum=10, maximum=200)
            )
        )
        
        self.ad_task = None
        self.message_count = 0
        self.total_sent = 0
        self.last_sent = "–ù–∏–∫–æ–≥–¥–∞"
        self.running = False
        
        # –°–ø–∏—Å–∫–∏ —á–∞—Ç–æ–≤
        self.main_chats = [
            "https://t.me/GalaxyChat_Garants",
            "https://t.me/garantferz",
            "https://t.me/loneasCHATIK", 
            "https://t.me/nft_chatp",
            "https://t.me/chatsell_clix",
            "https://t.me/syndicate_garant",
            "https://t.me/VIP_GARANT_Chat",
            "https://t.me/nft_chatiqs",
            "https://t.me/VIP_GARANT_Chat"
        ]
        
        self.special_chat = "https://t.me/TonTakeGarant"

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        self._me = await client.get_me()

    async def watcher(self, message: Message):
        """–°—á–µ—Ç—á–∏–∫ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        if hasattr(message, "out") and message.out:
            self.message_count += 1
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–µ—Ü-—Ä–∞—Å—Å—ã–ª–∫—É –∫–∞–∂–¥—ã–µ 73 —Å–æ–æ–±—â–µ–Ω–∏—è
            if self.message_count >= self.config["special_chat_delay"]:
                self.message_count = 0
                await self.send_special_ad()
    
    async def send_special_ad(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–µ—Ü-—á–∞—Ç"""
        try:
            message_text = (
                "üéØ <b>–ù–ê–ö–†–£–¢–ö–ê –î–õ–Ø –í–°–ï–• –ü–õ–ê–¢–§–û–†–ú:</b>\n"
                "‚Äî Telegram, TikTok, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Facebook, Instagram\n"
                "–£—Å–ª—É–≥–∏: –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, —Ä–µ–∞–∫—Ü–∏–∏, –ø–æ–¥–ø–∏—Å—á–∏–∫–∏, —Ä–µ–ø–æ—Å—Ç—ã, —Ä–µ—Ñ–µ—Ä–∞–ª—ã.\n\n"
                
                "‚≠êÔ∏è <b>–ó–í–Å–ó–î–´ –¢–ï–õ–ï–ì–†–ê–ú (–æ—Ç 1,000 —à—Ç.)</b> ‚Äî 1,450‚ÇΩ\n\n"
                
                "üá∫üá∏ <b>–ü–†–û–î–ê–ú –ê–ö–ö–ê–£–ù–¢–´ –°–®–ê (—Å—Ç–∞—Ä—ã–µ):</b>\n"
                "‚Ä¢ 2015 ‚Äî 950‚ÇΩ\n"
                "‚Ä¢ 2016 ‚Äî 750‚ÇΩ\n"
                "‚Ä¢ 2017 ‚Äî 520‚ÇΩ\n"
                "‚Ä¢ 2018 ‚Äî 450‚ÇΩ\n\n"
                
                "üíµ –û–ø–ª–∞—Ç—É –ø—Ä–∏–Ω–∏–º–∞—é –≤ ‚ÇΩ/–ö—Ä–∏–ø—Ç–µ/$"
            )
            
            await self.client.send_message(self.special_chat, message_text)
            self.total_sent += 1
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Å–ø–µ—Ü-—á–∞—Ç: {e}")

    async def send_main_ads(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã –≤–æ –≤—Å–µ —á–∞—Ç—ã"""
        if not self.running:
            return
            
        main_ad_text = (
            "üí∞ <b>–ü–†–ê–ô–°-–õ–ò–°–¢ –ù–ê –ì–ê–†–ê–ù–¢–ê</b>\n\n"
            "‚Ä¢ <b>1 –º–µ—Å—è—Ü</b> ‚Äî 150‚ÇΩ\n"
            "‚Ä¢ <b>3 –º–µ—Å—è—Ü–∞</b> ‚Äî 400‚ÇΩ\n"  
            "‚Ä¢ <b>6 –º–µ—Å—è—Ü–µ–≤</b> ‚Äî 750‚ÇΩ\n"
            "‚Ä¢ <b>12 –º–µ—Å—è—Ü–µ–≤</b> ‚Äî 1400‚ÇΩ\n\n"
            
            "üéØ <b>–ù–ê–ö–†–£–¢–ö–ê –î–õ–Ø –í–°–ï–• –ü–õ–ê–¢–§–û–†–ú:</b>\n"
            "‚Äî Telegram, TikTok, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Facebook, Instagram\n"
            "–£—Å–ª—É–≥–∏: –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, —Ä–µ–∞–∫—Ü–∏–∏, –ø–æ–¥–ø–∏—Å—á–∏–∫–∏, —Ä–µ–ø–æ—Å—Ç—ã, —Ä–µ—Ñ–µ—Ä–∞–ª—ã.\n\n"
            
            "üì± <b>Telegram-–∞–∫–∫–∞—É–Ω—Ç—ã</b>\n"
            "‚¨áÔ∏è <b>–í –Ω–∞–ª–∏—á–∏–∏</b> ‚¨áÔ∏è\n"
            "‚Ä¢ +1 –°–®–ê –ß–∏—Å—Ç—ã–π –∞–≤—Ç–æ—Ä–µ–≥ | –ü—É—Å—Ç–æ–π | ‚Äî 80‚ÇΩ\n"
            "‚Ä¢ +880 –ë–∞–Ω–≥–ª–∞–¥–µ—à | –ê–≤—Ç–æ—Ä–µ–≥ ‚Äî 80‚ÇΩ\n"
            "‚Ä¢ +95 –ú—å—è–Ω–º–∞ | –ê–≤—Ç–æ—Ä–µ–≥ | ‚Äî 80‚ÇΩ\n"
            "‚Ä¢ +254 –ö–µ–Ω–∏—è | –ê–≤—Ç–æ—Ä–µ–≥ ‚Äî 80‚ÇΩ\n"
            "<i>–û—Ç–ª–µ–∂–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è 7 –¥–Ω–µ–π - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è 6 –º–µ—Å—è—Ü–µ–≤</i>\n\n"
            
            "üá∫üá∏ <b>–ê–ö–ö–ê–£–ù–¢–´ –°–®–ê (—Å—Ç–∞—Ä—ã–µ):</b>\n"
            "‚Ä¢ 2015 –≥–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî 950‚ÇΩ\n"
            "‚Ä¢ 2016 –≥–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî 750‚ÇΩ\n"
            "‚Ä¢ 2017 –≥–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî 520‚ÇΩ\n"
            "‚Ä¢ 2018 –≥–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî 450‚ÇΩ\n\n"
            
            "üíµ –û–ø–ª–∞—Ç—É –ø—Ä–∏–Ω–∏–º–∞—é –≤ ‚ÇΩ/—Ç–æ–Ω/$/–≥–æ–ª–¥–µ –≤ –∏—Ä–∏—Å–µ\n\n"
            "‚ö†Ô∏è <i>–ó–∞ —Å–ª—ë—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–µ—Å—É</i> ‚ö†Ô∏è"
        )
        
        for chat in self.main_chats:
            if not self.running:
                break
                
            try:
                await self.client.send_message(chat, main_ad_text)
                self.total_sent += 1
                
                # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏
                await asyncio.sleep(self.config["delay_between_chats"])
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ {chat}: {e}")
                continue
        
        self.last_sent = datetime.now().strftime("%H:%M:%S")
        
        # –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞
        await asyncio.sleep(self.config["main_interval"])

    async def ad_task_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞—Å—Å—ã–ª–∫–∏"""
        while self.running:
            await self.send_main_ads()

    @loader.command()
    async def adstart(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–∞—Å—Å—ã–ª–∫—É"""
        if self.running:
            await utils.answer(message, "üîÑ <b>–†–∞—Å—Å—ã–ª–∫–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞</b>")
            return
            
        self.running = True
        self.message_count = 0
        self.ad_task = asyncio.create_task(self.ad_task_loop())
        
        await utils.answer(message, self.strings("on"))

    @loader.command()
    async def adstop(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É"""
        if not self.running:
            await utils.answer(message, "‚ùå <b>–†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞</b>")
            return
            
        self.running = False
        if self.ad_task:
            self.ad_task.cancel()
        
        await utils.answer(message, self.strings("off"))

    @loader.command()
    async def adstats(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞—Å—Å—ã–ª–∫–∏"""
        if not self.running:
            await utils.answer(message, "‚ùå <b>–†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞</b>")
            return
            
        next_send = self.config["main_interval"]
        
        stats_text = self.strings("stats").format(
            self.total_sent,
            self.last_sent,
            next_send,
            self.message_count,
            self.config["special_chat_delay"]
        )
        
        await utils.answer(message, stats_text)

    @loader.command()
    async def adtest(self, message):
        """–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ –≤—Å–µ —á–∞—Ç—ã (1 —Ä–∞–∑)"""
        old_state = self.running
        self.running = False
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã
        main_ad_text = "..."
        for chat in self.main_chats:
            try:
                await self.client.send_message(chat, main_ad_text)
                await asyncio.sleep(2)
            except:
                continue
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–µ—Ü-—Ä–µ–∫–ª–∞–º—ã
        await self.send_special_ad()
        
        self.running = old_state
        await utils.answer(message, "‚úÖ <b>–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</b>")
