# meta developer: @kiminaiq
# meta pic: https://img.icons8.com/color/48/000000/auto-replace.png
# meta description: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞ —Ä–≤ –Ω–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
# scope: hikka_only
# scope: hikka_min 1.6.0

from .. import loader, utils
import logging
import re

logger = logging.getLogger(__name__)

@loader.tds
class AutoReplacerMod(loader.Module):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞ —Ä–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"""
    
    strings = {
        "name": "AutoReplacer",
        "help": "üîÑ <b>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–º–µ–Ω–∞</b>\n\n"
                "üîß <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</b>\n"
                ".autoon - –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É\n"
                ".autooff - –í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É\n"
                ".autostatus - –°—Ç–∞—Ç—É—Å\n"
                ".addauto <—Å–ª–æ–≤–æ> <–∑–∞–º–µ–Ω–∞> - –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ\n"
                ".listauto - –°–ø–∏—Å–æ–∫ –∑–∞–º–µ–Ω\n"
                ".delauto <–Ω–æ–º–µ—Ä> - –£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ–Ω—É\n"
                ".testauto <—Ç–µ–∫—Å—Ç> - –¢–µ—Å—Ç –∑–∞–º–µ–Ω—ã\n\n"
                "üìù <b>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:</b>\n"
                "'—Ä–≤' ‚Üí '+79902136543 –ü–°–ë –ë–∞–Ω–∫\\n–í–∞—Å–∏–ª–∏–π –ö'",
        "enabled": "‚úÖ <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞</b>",
        "disabled": "‚èπÔ∏è <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞</b>",
        "already_enabled": "‚ö†Ô∏è <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞</b>",
        "already_disabled": "‚ö†Ô∏è <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ —É–∂–µ –≤—ã–∫–ª—é—á–µ–Ω–∞</b>",
        "status_on": "üü¢ <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞: –í–ö–õ–Æ–ß–ï–ù–ê</b>",
        "status_off": "üî¥ <b>–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞: –í–´–ö–õ–Æ–ß–ï–ù–ê</b>",
        "word_added": "‚úÖ <b>–î–æ–±–∞–≤–ª–µ–Ω–æ:</b> <code>{}</code> ‚Üí <code>{}</code>",
        "word_exists": "‚ö†Ô∏è <b>–°–ª–æ–≤–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</b>",
        "word_removed": "üóëÔ∏è <b>–£–¥–∞–ª–µ–Ω–æ:</b> <code>{}</code>",
        "no_words": "üì≠ <b>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–º–µ–Ω</b>",
        "words_list": "üìã <b>–°–ø–∏—Å–æ–∫ –∑–∞–º–µ–Ω:</b>\n{}",
        "invalid_number": "‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä</b>",
        "test_result": "üß™ <b>–¢–µ—Å—Ç –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—ã:</b>\n<b>–ò—Å—Ö–æ–¥–Ω—ã–π:</b> {}\n<b>–ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã:</b> {}",
        "replaced_info": "üîÑ <i>–°–æ–æ–±—â–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω–µ–Ω–æ</i>",
        "no_text": "‚ùå <b>–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∞</b>"
    }
    
    def __init__(self):
        self.replacements = [
            ("—Ä–≤", "+79902136543 –ü–°–ë –ë–∞–Ω–∫\n–í–∞—Å–∏–ª–∏–π –ö"),
            ("—Ä—Ñ", "üá∑üá∫ –†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è"),
            ("—Å–ø—Å", "–°–ø–∞—Å–∏–±–æ!"),
            ("–ø–∂", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞")
        ]
        self.enabled = True
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        
        saved_replacements = self.db.get(__name__, "replacements", None)
        if saved_replacements:
            self.replacements = saved_replacements
        
        saved_enabled = self.db.get(__name__, "enabled", None)
        if saved_enabled is not None:
            self.enabled = saved_enabled
        
        logger.info(f"AutoReplacer –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    async def watcher(self, message):
        if not self.enabled:
            return
        
        if not message.out or not message.text:
            return
        
        if message.text.startswith(('.autoon', '.autooff', '.autostatus', 
                                   '.addauto', '.listauto', '.delauto', '.testauto',
                                   '.autohelp', '.addrvauto')):
            return
        
        original_text = message.text
        replaced_text = self._apply_auto_replace(original_text)
        
        if replaced_text != original_text:
            try:
                await message.edit(replaced_text)
                await message.respond(self.strings("replaced_info"), reply_to=message.id)
                logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–º–µ–Ω–µ–Ω–æ")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞: {e}")
    
    @loader.command(
        ru_doc="–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É",
        en_doc="Enable auto-replace"
    )
    async def autooncmd(self, message):
        if self.enabled:
            await utils.answer(message, self.strings("already_enabled"))
            return
        
        self.enabled = True
        self.db.set(__name__, "enabled", True)
        await utils.answer(message, self.strings("enabled"))
    
    @loader.command(
        ru_doc="–í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É",
        en_doc="Disable auto-replace"
    )
    async def autooffcmd(self, message):
        if not self.enabled:
            await utils.answer(message, self.strings("already_disabled"))
            return
        
        self.enabled = False
        self.db.set(__name__, "enabled", False)
        await utils.answer(message, self.strings("disabled"))
    
    @loader.command(
        ru_doc="–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—ã",
        en_doc="Auto-replace status"
    )
    async def autostatuscmd(self, message):
        status_text = self.strings["status_on"] if self.enabled else self.strings["status_off"]
        info = f"{status_text}\nüìä <b>–ó–∞–º–µ–Ω:</b> {len(self.replacements)}"
        await utils.answer(message, info)
    
    @loader.command(
        ru_doc="<—Å–ª–æ–≤–æ> <–∑–∞–º–µ–Ω–∞> - –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É",
        en_doc="<word> <replacement> - Add auto-replacement"
    )
    async def addautocmd(self, message):
        args = utils.get_args(message)
        
        if len(args) < 2:
            await utils.answer(message, "‚ùå –§–æ—Ä–º–∞—Ç: .addauto <—Å–ª–æ–≤–æ> <–∑–∞–º–µ–Ω–∞>")
            return
        
        word = args[0].lower()
        replacement = " ".join(args[1:])
        
        for existing_word, _ in self.replacements:
            if existing_word == word:
                await utils.answer(message, self.strings("word_exists"))
                return
        
        self.replacements.insert(0, (word, replacement))
        self._save_replacements()
        
        await utils.answer(message, self.strings("word_added").format(word, replacement))
    
    @loader.command(
        ru_doc="–°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ-–∑–∞–º–µ–Ω",
        en_doc="List auto-replacements"
    )
    async def listautocmd(self, message):
        if not self.replacements:
            await utils.answer(message, self.strings("no_words"))
            return
        
        list_text = ""
        for i, (word, replacement) in enumerate(self.replacements, 1):
            list_text += f"{i}. <code>{word}</code> ‚Üí <code>{replacement[:30]}</code>\n"
        
        await utils.answer(message, self.strings("words_list").format(list_text))
    
    @loader.command(
        ru_doc="<–Ω–æ–º–µ—Ä> - –£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—É",
        en_doc="<number> - Remove auto-replacement"
    )
    async def delautocmd(self, message):
        args = utils.get_args(message)
        
        if not args:
            await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä")
            return
        
        try:
            word_num = int(args[0]) - 1
            
            if 0 <= word_num < len(self.replacements):
                removed_word, _ = self.replacements.pop(word_num)
                self._save_replacements()
                await utils.answer(message, self.strings("word_removed"].format(removed_word))
            else:
                await utils.answer(message, self.strings("invalid_number"))
        except:
            await utils.answer(message, self.strings("invalid_number"))
    
    @loader.command(
        ru_doc="<—Ç–µ–∫—Å—Ç> - –¢–µ—Å—Ç –∞–≤—Ç–æ-–∑–∞–º–µ–Ω—ã",
        en_doc="<text> - Test auto-replacement"
    )
    async def testautocmd(self, message):
        text = utils.get_args_raw(message)
        
        if not text:
            await utils.answer(message, self.strings("no_text"))
            return
        
        replaced_text = self._apply_auto_replace(text)
        await utils.answer(message, self.strings("test_result").format(text, replaced_text))
    
    @loader.command(
        ru_doc="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–≤",
        en_doc="Quick add —Ä–≤"
    )
    async def addrvautocmd(self, message):
        self.replacements = [(w, r) for w, r in self.replacements if w != "—Ä–≤"]
        self.replacements.insert(0, ("—Ä–≤", "+79902136543 –ü–°–ë –ë–∞–Ω–∫\n–í–∞—Å–∏–ª–∏–π –ö"))
        self._save_replacements()
        
        await utils.answer(message, "‚úÖ –ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞ '—Ä–≤' –¥–æ–±–∞–≤–ª–µ–Ω–∞")
    
    @loader.command(
        ru_doc="–ü–æ–º–æ—â—å",
        en_doc="Help"
    )
    async def autohelpcmd(self, message):
        await utils.answer(message, self.strings("help"))
    
    def _apply_auto_replace(self, text):
        result = text
        for word, replacement in self.replacements:
            pattern = r'\b' + re.escape(word) + r'\b'
            result = re.sub(pattern, replacement, result, flags=re.IGNORECASE)
        return result
    
    def _save_replacements(self):
        self.db.set(__name__, "replacements", self.replacements)
    
    async def on_unload(self):
        self._save_replacements()
        self.db.set(__name__, "enabled", self.enabled)
