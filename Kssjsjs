# meta developer: @your_username
# meta pic: https://img.icons8.com/color/48/000000/incognito.png
# meta description: –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ —Å–∫—Ä—ã—Ç–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞
# scope: hikka_only
# scope: hikka_min 1.6.0

import asyncio
import time
from datetime import datetime
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class StealthCrossPoster(loader.Module):
    """–ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã—Ç–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞"""
    
    strings = {
        "name": "StealthPoster",
        "help": "üîÑ <b>–°–∫—Ä—ã—Ç–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞</b>\n\n"
                "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
                ".stealthstart - –ó–∞–ø—É—Å—Ç–∏—Ç—å\n"
                ".stealthstop - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å\n"
                ".stealthstatus - –°—Ç–∞—Ç—É—Å\n"
                ".stealthmode <on/off> - –†–µ–∂–∏–º —Å–∫—Ä—ã—Ç–∏—è\n"
                ".stealthtest - –¢–µ—Å—Ç\n"
                ".stealthlist - –ß–∞—Ç—ã\n",
        "started": "‚úÖ <b>–ó–∞–ø—É—â–µ–Ω–æ!</b>\n"
                   "üé≠ <b>–†–µ–∂–∏–º:</b> {}\n"
                   "üì§ <b>–ò—Å—Ç–æ—á–Ω–∏–∫:</b> {}\n"
                   "üì¢ <b>–ß–∞—Ç–æ–≤:</b> {}\n"
                   "‚è± <b>–¶–∏–∫–ª:</b> {} —Å–µ–∫\n"
                   "‚è≥ <b>–ò–Ω—Ç–µ—Ä–≤–∞–ª:</b> {} —Å–µ–∫",
        "stopped": "‚èπÔ∏è <b>–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</b>",
        "mode_changed": "üé≠ <b>–†–µ–∂–∏–º —Å–∫—Ä—ã—Ç–∏—è:</b> {}",
        "already_on": "‚ö†Ô∏è <b>–£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</b>",
        "not_running": "üì≠ <b>–ù–µ –∑–∞–ø—É—â–µ–Ω–æ</b>",
        "test_sent": "üß™ <b>–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</b>",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞:</b> {}"
    }
    
    def __init__(self):
        self.task = None
        self.is_running = False
        self.hide_source = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
        
        # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
        self.source_link = "https://t.me/manqiin/54"
        self.message_text = None  # –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        
        # –ß–∞—Ç—ã
        self.target_chats = [
            "@GalaxyChat_Garants",
            "@garantferz", 
            "@loneasCHATIK",
            "@nft_chatp",
            "@chatsell_clix",
            "@syndicate_garant",
            "@VIP_GARANT_Chat",
            "@nft_chatiqs"
        ]
        
        # –û—Å–æ–±—ã–π —á–∞—Ç –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
        self.special_chat = "@TonTakeGarant"
        self.special_text = """üéØ –ù–ê–ö–†–£–¢–ö–ê –î–õ–Ø –í–°–ï–• –ü–õ–ê–¢–§–û–†–ú:
‚Äî Telegram, TikTok, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Facebook, Instagram
–£—Å–ª—É–≥–∏: –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, —Ä–µ–∞–∫—Ü–∏–∏, –ø–æ–¥–ø–∏—Å—á–∏–∫–∏, —Ä–µ–ø–æ—Å—Ç—ã, —Ä–µ—Ñ–µ—Ä–∞–ª—ã.

‚≠êÔ∏è –ó–í–Å–ó–î–´ –¢–ï–õ–ï–ì–†–ê–ú (–æ—Ç 1,000 —à—Ç.) ‚Äî 1,450‚ÇΩ

üá∫üá∏ –ü–†–û–î–ê–ú –ê–ö–ö–ê–£–ù–¢–´ –°–®–ê (—Å—Ç–∞—Ä—ã–µ):
‚Ä¢ 2015 ‚Äî 950‚ÇΩ
‚Ä¢ 2016 ‚Äî 750‚ÇΩ
‚Ä¢ 2017 ‚Äî 520‚ÇΩ
‚Ä¢ 2018 ‚Äî 450‚ÇΩ

üíµ –û–ø–ª–∞—Ç—É –ø—Ä–∏–Ω–∏–º–∞—é –≤ ‚ÇΩ/–ö—Ä–∏–ø—Ç–µ/$"""
        
        # –¢–∞–π–º–∏–Ω–≥–∏
        self.full_cycle = 607
        self.chat_interval = 16
        self.special_every = 73
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.message_count = 0
        self.special_count = 0
        self.cycle_count = 0
        self.current_chat_index = 0
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        
        # –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        await self._load_source_message()
        
        logger.info("StealthPoster –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    @loader.command(
        ru_doc="–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä—ã—Ç—É—é –ø–µ—Ä–µ—Å—ã–ª–∫—É",
        en_doc="Start stealth cross-posting"
    )
    async def stealthstartcmd(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å"""
        if self.is_running:
            await utils.answer(message, self.strings("already_on"))
            return
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        loaded = await self._load_source_message()
        if not loaded and self.hide_source:
            await utils.answer(message, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            return
        
        self.is_running = True
        self.task = asyncio.create_task(self._stealth_loop())
        
        mode = "–°–ö–†–´–¢–´–ô" if self.hide_source else "–û–¢–ö–†–´–¢–´–ô"
        
        await utils.answer(
            message,
            self.strings("started").format(
                mode,
                self.source_link,
                len(self.target_chats),
                self.full_cycle,
                self.chat_interval
            )
        )
        
        logger.info(f"–°–∫—Ä—ã—Ç–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞, —Ä–µ–∂–∏–º: {mode}")
    
    @loader.command(
        ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É",
        en_doc="Stop posting"
    )
    async def stealthstopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"""
        if not self.is_running:
            await utils.answer(message, self.strings("not_running"))
            return
        
        self.is_running = False
        if self.task:
            self.task.cancel()
            self.task = None
        
        await utils.answer(message, self.strings("stopped"))
        logger.info("–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
    
    @loader.command(
        ru_doc="<on/off> - –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Å–∫—Ä—ã—Ç–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞",
        en_doc="<on/off> - Toggle source hiding"
    )
    async def stealthmodecmd(self, message):
        """–†–µ–∂–∏–º —Å–∫—Ä—ã—Ç–∏—è"""
        args = utils.get_args_raw(message).lower()
        
        if args == "on":
            self.hide_source = True
            mode = "–í–ö–õ–Æ–ß–ï–ù–û"
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Å–∫—Ä—ã—Ç–∏—è
            await self._load_source_message()
        elif args == "off":
            self.hide_source = False
            mode = "–í–´–ö–õ–Æ–ß–ï–ù–û"
        else:
            current = "–í–ö–õ–Æ–ß–ï–ù–û" if self.hide_source else "–í–´–ö–õ–Æ–ß–ï–ù–û"
            await utils.answer(message, f"üé≠ <b>–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º:</b> {current}")
            return
        
        await utils.answer(message, self.strings("mode_changed").format(mode))
        logger.info(f"–†–µ–∂–∏–º —Å–∫—Ä—ã—Ç–∏—è: {mode}")
    
    @loader.command(
        ru_doc="–°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ—Å—ã–ª–∫–∏",
        en_doc="Posting status"
    )
    async def stealthstatuscmd(self, message):
        """–°—Ç–∞—Ç—É—Å"""
        status = "üü¢ –†–∞–±–æ—Ç–∞–µ—Ç" if self.is_running else "üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
        mode = "üé≠ –°–∫—Ä—ã—Ç—ã–π" if self.hide_source else "üì§ –û—Ç–∫—Ä—ã—Ç—ã–π"
        
        info = f"üìä <b>–°—Ç–∞—Ç—É—Å:</b> {status}\n"
        info += f"{mode}\n"
        info += f"üì§ <b>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</b> {self.message_count}\n"
        info += f"üéØ <b>–û—Å–æ–±—ã—Ö:</b> {self.special_count}\n"
        info += f"üîÑ <b>–¶–∏–∫–ª–æ–≤:</b> {self.cycle_count}\n"
        info += f"üí¨ <b>–¢–µ–∫—É—â–∏–π —á–∞—Ç:</b> {self.target_chats[self.current_chat_index] if self.current_chat_index < len(self.target_chats) else '‚Äî'}"
        
        await utils.answer(message, info)
    
    @loader.command(
        ru_doc="–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞",
        en_doc="Test send"
    )
    async def stealthtestcmd(self, message):
        """–¢–µ—Å—Ç"""
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
            if not self.message_text and self.hide_source:
                loaded = await self._load_source_message()
                if not loaded:
                    await utils.answer(message, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ")
                    return
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ø–µ—Ä–≤—ã–π —á–∞—Ç –¥–ª—è —Ç–µ—Å—Ç–∞
            chat = self.target_chats[0] if self.target_chats else "@GalaxyChat_Garants"
            
            if self.hide_source and self.message_text:
                # –°–∫—Ä—ã—Ç—ã–π —Ä–µ–∂–∏–º - –∫–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
                await self._send_hidden_copy(chat, self.message_text)
            else:
                # –û—Ç–∫—Ä—ã—Ç—ã–π —Ä–µ–∂–∏–º - –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º
                await self._forward_message(chat)
            
            await utils.answer(message, self.strings("test_sent"))
            
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤",
        en_doc="Show chat list"
    )
    async def stealthlistcmd(self, message):
        """–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤"""
        chat_list = "<b>üìã –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤:</b>\n\n"
        
        for i, chat in enumerate(self.target_chats, 1):
            chat_list += f"{i}. {chat}\n"
        
        chat_list += f"\n<b>üéØ –û—Å–æ–±—ã–π —á–∞—Ç:</b> {self.special_chat}"
        chat_list += f"\n<b>üìä –í—Å–µ–≥–æ:</b> {len(self.target_chats)} —á–∞—Ç–æ–≤"
        
        await utils.answer(message, chat_list)
    
    async def _stealth_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Å–∫—Ä—ã—Ç–æ–π –ø–µ—Ä–µ—Å—ã–ª–∫–∏"""
        logger.info(f"–¶–∏–∫–ª –∑–∞–ø—É—â–µ–Ω, —Ä–µ–∂–∏–º: {'—Å–∫—Ä—ã—Ç—ã–π' if self.hide_source else '–æ—Ç–∫—Ä—ã—Ç—ã–π'}")
        
        while self.is_running:
            try:
                # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º
                for i, chat in enumerate(self.target_chats):
                    if not self.is_running:
                        break
                    
                    self.current_chat_index = i
                    
                    try:
                        if self.hide_source and self.message_text:
                            # –°–ö–†–´–¢–´–ô –†–ï–ñ–ò–ú: –∫–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                            await self._send_hidden_copy(chat, self.message_text)
                        else:
                            # –û–¢–ö–†–´–¢–´–ô –†–ï–ñ–ò–ú: –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                            await self._forward_message(chat)
                        
                        self.message_count += 1
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–æ–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if self.message_count % self.special_every == 0:
                            await self._send_special_message()
                            self.special_count += 1
                        
                        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {chat} (—Ä–µ–∂–∏–º: {'—Å–∫—Ä—ã—Ç—ã–π' if self.hide_source else '–æ—Ç–∫—Ä—ã—Ç—ã–π'})")
                        
                        # –ñ–¥–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏
                        if i < len(self.target_chats) - 1:
                            for _ in range(self.chat_interval):
                                if not self.is_running:
                                    break
                                await asyncio.sleep(1)
                        
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –≤ {chat}: {e}")
                        await asyncio.sleep(5)
                
                # –ó–∞–≤–µ—Ä—à–∏–ª–∏ —Ü–∏–∫–ª
                self.cycle_count += 1
                self.current_chat_index = 0
                
                # –ñ–¥–µ–º –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª
                if self.is_running:
                    logger.info(f"–¶–∏–∫–ª #{self.cycle_count} –∑–∞–≤–µ—Ä—à–µ–Ω. –ñ–¥–µ–º {self.full_cycle} —Å–µ–∫")
                    
                    for _ in range(self.full_cycle):
                        if not self.is_running:
                            break
                        await asyncio.sleep(1)
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ: {e}")
                await asyncio.sleep(30)
    
    async def _load_source_message(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        try:
            # –ü–∞—Ä—Å–∏–º —Å—Å—ã–ª–∫—É: https://t.me/manqiin/54
            parts = self.source_link.split('/')
            if len(parts) >= 5:
                channel = parts[3]  # manqiin
                msg_id = int(parts[4])  # 54
                
                # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                msg = await self.client.get_messages(channel, ids=msg_id)
                
                if msg:
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏ –º–µ–¥–∏–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    self.message_text = msg.text or msg.caption or ""
                    
                    # –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    self.message_media = msg.media
                    self.message_entities = msg.entities
                    
                    logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {len(self.message_text)} —Å–∏–º–≤–æ–ª–æ–≤")
                    return True
            
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ")
            return False
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return False
    
    async def _send_hidden_copy(self, chat, text):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∫—Ä—ã—Ç–æ–π –∫–æ–ø–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        try:
            if hasattr(self, 'message_media') and self.message_media:
                # –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞ —Å —Ç–µ–∫—Å—Ç–æ–º
                await self.client.send_file(
                    chat,
                    self.message_media,
                    caption=text,
                    parse_mode=None
                )
            else:
                # –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
                await self.client.send_message(
                    chat,
                    text,
                    parse_mode=None
                )
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫—Ä—ã—Ç–æ–π –∫–æ–ø–∏–∏: {e}")
            return False
    
    async def _forward_message(self, chat):
        """–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        try:
            parts = self.source_link.split('/')
            channel = parts[3]
            msg_id = int(parts[4])
            
            msg = await self.client.get_messages(channel, ids=msg_id)
            if msg:
                await msg.forward_to(chat)
                return True
            return False
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏: {e}")
            return False
    
    async def _send_special_message(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å–æ–±–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        try:
            await self.client.send_message(
                self.special_chat,
                self.special_text,
                parse_mode=None
            )
            logger.info(f"–û—Å–æ–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {self.special_chat}")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Å–æ–±–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return False
    
    async def on_unload(self):
        """–û—á–∏—Å—Ç–∫–∞"""
        self.is_running = False
        if self.task:
            self.task.cancel()
