# meta developer: @your_username
# meta pic: https://img.icons8.com/color/48/000000/broadcast-message.png
# meta description: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç—ã –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
# scope: hikka_only
# scope: hikka_min 1.6.0

import asyncio
import time
from datetime import datetime
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class CrossPoster(loader.Module):
    """–ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç—ã –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é"""
    
    strings = {
        "name": "CrossPoster",
        "help": "üîÑ <b>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞</b>\n\n"
                "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
                ".crossstart - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É\n"
                ".crossstop - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É\n"
                ".crossstatus - –°—Ç–∞—Ç—É—Å\n"
                ".crosstest - –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞\n"
                ".crosscount - –°—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π\n",
        "started": "‚úÖ <b>–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!</b>\n"
                   "üì§ <b>–ò—Å—Ç–æ—á–Ω–∏–∫:</b> @manqiin/54\n"
                   "üì¢ <b>–ß–∞—Ç—ã:</b> {} —à—Ç.\n"
                   "‚è± <b>–¶–∏–∫–ª:</b> {} —Å–µ–∫\n"
                   "‚è≥ <b>–ò–Ω—Ç–µ—Ä–≤–∞–ª:</b> {} —Å–µ–∫ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏\n"
                   "üéØ <b>–û—Å–æ–±—ã–π:</b> @TonTakeGarant –∫–∞–∂–¥—ã–µ {} —Å–æ–æ–±—â–µ–Ω–∏–π",
        "stopped": "‚èπÔ∏è <b>–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</b>",
        "already_running": "‚ö†Ô∏è <b>–£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</b>",
        "not_running": "üì≠ <b>–ù–µ –∑–∞–ø—É—â–µ–Ω–∞</b>",
        "status": "üìä <b>–°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ—Å—ã–ª–∫–∏:</b>\n"
                  "üîÑ <b>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</b> {}\n"
                  "üì§ <b>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</b> {} —Å–æ–æ–±—â–µ–Ω–∏–π\n"
                  "üéØ <b>–û—Å–æ–±—ã—Ö:</b> {} –æ—Ç–ø—Ä–∞–≤–æ–∫\n"
                  "‚è∞ <b>–°–ª–µ–¥—É—é—â–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞:</b> —á–µ—Ä–µ–∑ {} —Å–µ–∫\n"
                  "üí¨ <b>–¢–µ–∫—É—â–∏–π —á–∞—Ç:</b> {}",
        "test_sent": "üß™ <b>–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ —á–∞—Ç—ã</b>",
        "message_sent": "üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {} | –í—Å–µ–≥–æ: {}",
        "special_sent": "üéØ <b>–û—Å–æ–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ @TonTakeGarant</b>",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞:</b> {}",
        "counter": "üìä <b>–°—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π:</b>\n"
                   "‚Ä¢ –û–±—â–∏—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫: {}\n"
                   "‚Ä¢ –û—Å–æ–±—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫: {}\n"
                   "‚Ä¢ –¶–∏–∫–ª–æ–≤: {}\n"
                   "‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞: {}"
    }
    
    def __init__(self):
        self.task = None
        self.is_running = False
        self.source_message = "https://t.me/manqiin/54"
        
        # –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏
        self.target_chats = [
            "@GalaxyChat_Garants",
            "@garantferz", 
            "@loneasCHATIK",
            "@nft_chatp",
            "@chatsell_clix",
            "@syndicate_garant",
            "@VIP_GARANT_Chat",
            "@nft_chatiqs"
        ]
        
        # –û—Å–æ–±—ã–π —á–∞—Ç
        self.special_chat = "@TonTakeGarant"
        self.special_message = """üéØ –ù–ê–ö–†–£–¢–ö–ê –î–õ–Ø –í–°–ï–• –ü–õ–ê–¢–§–û–†–ú:
‚Äî Telegram, TikTok, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Facebook, Instagram
–£—Å–ª—É–≥–∏: –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, —Ä–µ–∞–∫—Ü–∏–∏, –ø–æ–¥–ø–∏—Å—á–∏–∫–∏, —Ä–µ–ø–æ—Å—Ç—ã, —Ä–µ—Ñ–µ—Ä–∞–ª—ã.

‚≠êÔ∏è –ó–í–Å–ó–î–´ –¢–ï–õ–ï–ì–†–ê–ú (–æ—Ç 1,000 —à—Ç.) ‚Äî 1,450‚ÇΩ

üá∫üá∏ –ü–†–û–î–ê–ú –ê–ö–ö–ê–£–ù–¢–´ –°–®–ê (—Å—Ç–∞—Ä—ã–µ):
‚Ä¢ 2015 ‚Äî 950‚ÇΩ
‚Ä¢ 2016 ‚Äî 750‚ÇΩ
‚Ä¢ 2017 ‚Äî 520‚ÇΩ
‚Ä¢ 2018 ‚Äî 450‚ÇΩ

üíµ –û–ø–ª–∞—Ç—É –ø—Ä–∏–Ω–∏–º–∞—é –≤ ‚ÇΩ/–ö—Ä–∏–ø—Ç–µ/$"""
        
        # –¢–∞–π–º–∏–Ω–≥–∏ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
        self.full_cycle = 607      # –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª
        self.chat_interval = 16    # –ú–µ–∂–¥—É —á–∞—Ç–∞–º–∏
        self.special_every = 73    # –û—Å–æ–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ N –æ–±—â–∏—Ö
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.message_count = 0
        self.special_count = 0
        self.cycle_count = 0
        self.last_sent_time = None
        self.current_chat_index = 0
        self.next_send_time = 0
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("CrossPoster –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    @loader.command(
        ru_doc="–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø–µ—Ä–µ—Å—ã–ª–∫—É",
        en_doc="Start automatic cross-posting"
    )
    async def crossstartcmd(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É"""
        if self.is_running:
            await utils.answer(message, self.strings("already_running"))
            return
        
        self.is_running = True
        self.task = asyncio.create_task(self._crosspost_loop())
        
        await utils.answer(
            message,
            self.strings("started").format(
                len(self.target_chats),
                self.full_cycle,
                self.chat_interval,
                self.special_every
            )
        )
        
        logger.info(f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞, —á–∞—Ç–æ–≤: {len(self.target_chats)}")
    
    @loader.command(
        ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É",
        en_doc="Stop cross-posting"
    )
    async def crossstopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É"""
        if not self.is_running:
            await utils.answer(message, self.strings("not_running"))
            return
        
        self.is_running = False
        if self.task:
            self.task.cancel()
            self.task = None
        
        await utils.answer(message, self.strings("stopped"))
        logger.info("–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
    
    @loader.command(
        ru_doc="–°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ—Å—ã–ª–∫–∏",
        en_doc="Cross-posting status"
    )
    async def crossstatuscmd(self, message):
        """–°—Ç–∞—Ç—É—Å"""
        status = "üü¢ –†–∞–±–æ—Ç–∞–µ—Ç" if self.is_running else "üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
        
        time_left = "‚Äî"
        current_chat = "‚Äî"
        
        if self.is_running and self.next_send_time > time.time():
            time_left = int(self.next_send_time - time.time())
            if 0 <= self.current_chat_index < len(self.target_chats):
                current_chat = self.target_chats[self.current_chat_index]
        
        await utils.answer(
            message,
            self.strings("status").format(
                status,
                self.message_count,
                self.special_count,
                time_left,
                current_chat
            )
        )
    
    @loader.command(
        ru_doc="–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ –≤—Å–µ —á–∞—Ç—ã",
        en_doc="Test send to all chats"
    )
    async def crosstestcmd(self, message):
        """–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞"""
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±—ã—á–Ω—ã–µ —á–∞—Ç—ã
            for chat in self.target_chats:
                try:
                    await self._forward_to_chat(chat)
                    logger.info(f"–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ {chat}")
                    await asyncio.sleep(1)  # –ú–∞–ª–µ–Ω—å–∫–∞—è –ø–∞—É–∑–∞
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ {chat}: {e}")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å–æ–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await self._send_special_message()
            
            await utils.answer(message, self.strings("test_sent"))
            
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–°—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π",
        en_doc="Message counter"
    )
    async def crosscountcmd(self, message):
        """–°—á–µ—Ç—á–∏–∫"""
        last_time = "‚Äî"
        if self.last_sent_time:
            last_time = datetime.fromtimestamp(self.last_sent_time).strftime("%H:%M:%S")
        
        await utils.answer(
            message,
            self.strings("counter").format(
                self.message_count,
                self.special_count,
                self.cycle_count,
                last_time
            )
        )
    
    @loader.command(
        ru_doc="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ—Å–æ–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
        en_doc="Send only special message"
    )
    async def crossspecialcmd(self, message):
        """–û—Å–æ–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        try:
            await self._send_special_message()
            await utils.answer(message, self.strings("special_sent"))
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤",
        en_doc="Show chat list"
    )
    async def crosslistcmd(self, message):
        """–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤"""
        chat_list = "üìã <b>–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤:</b>\n\n"
        
        for i, chat in enumerate(self.target_chats, 1):
            chat_list += f"{i}. {chat}\n"
        
        chat_list += f"\nüéØ <b>–û—Å–æ–±—ã–π —á–∞—Ç:</b> {self.special_chat}"
        chat_list += f"\n\nüìä <b>–í—Å–µ–≥–æ —á–∞—Ç–æ–≤:</b> {len(self.target_chats)}"
        
        await utils.answer(message, chat_list)
    
    async def _crosspost_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø–µ—Ä–µ—Å—ã–ª–∫–∏"""
        logger.info("–¶–∏–∫–ª –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –∑–∞–ø—É—â–µ–Ω")
        
        while self.is_running:
            try:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ –≤—Å–µ –æ–±—ã—á–Ω—ã–µ —á–∞—Ç—ã —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
                for i, chat in enumerate(self.target_chats):
                    if not self.is_running:
                        break
                    
                    try:
                        # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        await self._forward_to_chat(chat)
                        
                        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        self.message_count += 1
                        self.last_sent_time = time.time()
                        self.current_chat_index = i
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Å–æ–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if self.message_count % self.special_every == 0:
                            await self._send_special_message()
                            self.special_count += 1
                        
                        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {chat} | –í—Å–µ–≥–æ: {self.message_count}")
                        
                        # –ñ–¥–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ)
                        if i < len(self.target_chats) - 1:
                            self.next_send_time = time.time() + self.chat_interval
                            for _ in range(self.chat_interval):
                                if not self.is_running:
                                    break
                                await asyncio.sleep(1)
                        
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ {chat}: {e}")
                        await asyncio.sleep(5)  # –ü–∞—É–∑–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                
                # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ü–∏–∫–ª–æ–≤
                self.cycle_count += 1
                
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —á–∞—Ç–∞
                self.current_chat_index = 0
                
                # –ñ–¥–µ–º –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª (607 —Å–µ–∫—É–Ω–¥)
                if self.is_running:
                    wait_time = self.full_cycle
                    self.next_send_time = time.time() + wait_time
                    
                    logger.info(f"–¶–∏–∫–ª #{self.cycle_count} –∑–∞–≤–µ—Ä—à–µ–Ω. –ñ–¥–µ–º {wait_time} —Å–µ–∫")
                    
                    # –†–∞–∑–±–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
                    for _ in range(wait_time):
                        if not self.is_running:
                            break
                        await asyncio.sleep(1)
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏: {e}")
                await asyncio.sleep(30)  # –ü–∞—É–∑–∞ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
    
    async def _forward_to_chat(self, chat):
        """–ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç"""
        try:
            # –ü–∞—Ä—Å–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
            # –§–æ—Ä–º–∞—Ç: https://t.me/manqiin/54
            parts = self.source_message.split('/')
            if len(parts) >= 5:
                channel = parts[3]  # manqiin
                msg_id = int(parts[4])  # 54
                
                # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                source_msg = await self.client.get_messages(channel, ids=msg_id)
                
                if source_msg:
                    # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    await source_msg.forward_to(chat)
                    return True
            
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å–ª–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await self.client.send_message(
                chat,
                f"üì® –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑: {self.source_message}",
                parse_mode=None
            )
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –≤ {chat}: {e}")
            return False
    
    async def _send_special_message(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å–æ–±–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        try:
            await self.client.send_message(
                self.special_chat,
                self.special_message,
                parse_mode=None
            )
            logger.info(f"–û—Å–æ–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {self.special_chat}")
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Å–æ–±–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return False
    
    async def on_unload(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ"""
        self.is_running = False
        if self.task:
            self.task.cancel()
