# meta developer: @—Ç–≤–æ–π_–Ω–∏–∫
# meta pic: https://img.icons8.com/color/48/000000/artificial-intelligence.png
# scope: hikka_only
# scope: hikka_min 1.6.0

import asyncio
import aiohttp
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class GeminiChatMod(loader.Module):
    """–û–±—â–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —á–µ—Ä–µ–∑ Gemini AI"""

    strings = {
        "name": "GeminiChat",
        "no_api_key": "üö´ <b>API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!</b>\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>.gkey <–≤–∞—à_–∫–ª—é—á></code>",
        "config_done": "‚úÖ <b>–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω.</b>",
        "already_on": "‚ö†Ô∏è <b>–£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</b>",
        "already_off": "‚ö†Ô∏è <b>–£–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</b>",
        "started": "ü§ñ <b>–†–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å Gemini –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¥–ª—è {}</b>",
        "stopped": "‚èπÔ∏è <b>–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</b>",
        "status_on": "üü¢ <b>–°—Ç–∞—Ç—É—Å:</b> –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è {}",
        "status_off": "üî¥ <b>–°—Ç–∞—Ç—É—Å:</b> –ù–µ –∞–∫—Ç–∏–≤–µ–Ω",
        "waiting": "ü§î <b>Gemini –¥—É–º–∞–µ—Ç...</b>",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞ Gemini:</b> {}",
        "models_list": "üìã <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:</b>\n{}",
        "no_models": "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π"
    }

    def __init__(self):
        self.target_user = "@rostovskiy7777"
        self.config = loader.ModuleConfig(
            loader.ConfigValue(
                "gemini_api_key",
                None,
                "API –∫–ª—é—á Google Gemini",
                validator=loader.validators.String()
            ),
            loader.ConfigValue(
                "gemini_model",
                "models/gemini-1.5-flash",  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                "–ú–æ–¥–µ–ª—å Gemini",
                validator=loader.validators.String()
            ),
            loader.ConfigValue(
                "system_prompt",
                "–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ.",
                "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç",
                validator=loader.validators.String()
            )
        )
        self.is_active = False
        self.user_id = None
        self.available_models = []

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        try:
            entity = await client.get_entity(self.target_user)
            self.user_id = entity.id
            logger.info(f"–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {self.target_user}")
        except:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ {self.target_user}")

    @loader.command(ru_doc="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å API –∫–ª—é—á")
    async def gkeycmd(self, message):
        key = utils.get_args_raw(message)
        if not key:
            await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á")
            return
        self.config["gemini_api_key"] = key
        await utils.answer(message, self.strings("config_done"))

    @loader.command(ru_doc="–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏")
    async def gmodelscmd(self, message):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–∏–µ –º–æ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç"""
        if not self.config["gemini_api_key"]:
            await utils.answer(message, self.strings("no_api_key"))
            return
        
        models = await self._get_available_models()
        if models:
            text = "\n".join([f"‚Ä¢ <code>{m}</code>" for m in models[:10]])
            await utils.answer(message, self.strings("models_list").format(text))
        else:
            await utils.answer(message, self.strings("no_models"))

    @loader.command(ru_doc="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å")
    async def gmodelcmd(self, message):
        """<–º–æ–¥–µ–ª—å> - –í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å"""
        model = utils.get_args_raw(message)
        if not model:
            await utils.answer(message, f"üìù –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å: {self.config['gemini_model']}")
            return
        
        # –î–æ–±–∞–≤–ª—è–µ–º models/ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if not model.startswith("models/"):
            model = f"models/{model}"
        
        self.config["gemini_model"] = model
        await utils.answer(message, f"‚úÖ –ú–æ–¥–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: {model}")

    @loader.command(ru_doc="–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ-–æ—Ç–≤–µ—Ç")
    async def gstartcmd(self, message):
        if self.is_active:
            await utils.answer(message, self.strings("already_on").format(self.target_user))
            return
        if not self.config["gemini_api_key"]:
            await utils.answer(message, self.strings("no_api_key"))
            return
        self.is_active = True
        await utils.answer(message, self.strings("started").format(self.target_user))

    @loader.command(ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å")
    async def gstopcmd(self, message):
        if not self.is_active:
            await utils.answer(message, self.strings("already_off"))
            return
        self.is_active = False
        await utils.answer(message, self.strings("stopped"))

    @loader.command(ru_doc="–°—Ç–∞—Ç—É—Å")
    async def gstatuscmd(self, message):
        status = self.strings("status_on").format(self.target_user) if self.is_active else self.strings("status_off")
        await utils.answer(
            message,
            f"{status}\nü§ñ <b>–ú–æ–¥–µ–ª—å:</b> {self.config['gemini_model']}\nüîë <b>–ö–ª—é—á:</b> {'‚úÖ' if self.config['gemini_api_key'] else '‚ùå'}"
        )

    @loader.command(ru_doc="–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç")
    async def gtestcmd(self, message):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å '–ü—Ä–∏–≤–µ—Ç'"""
        if not self.config["gemini_api_key"]:
            await utils.answer(message, self.strings("no_api_key"))
            return
        
        thinking = await utils.answer(message, self.strings("waiting"))
        response = await self._query_gemini("–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?")
        await thinking.edit(f"üß™ <b>–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:</b>\n{response}")

    async def watcher(self, message):
        if not self.is_active:
            return
        if not self.config["gemini_api_key"]:
            return
        if not message.is_private:
            return
        if message.sender_id != self.user_id:
            return
        if message.out:
            return
        if not message.raw_text:
            return

        logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {self.target_user}")
        thinking = await message.reply(self.strings("waiting"))
        response = await self._query_gemini(message.raw_text)
        await thinking.edit(response)

    async def _get_available_models(self):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π"""
        api_key = self.config["gemini_api_key"]
        url = f"https://generativelanguage.googleapis.com/v1beta/models?key={api_key}"
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(url) as resp:
                    if resp.status == 200:
                        data = await resp.json()
                        models = [m["name"] for m in data.get("models", []) 
                                 if "generateContent" in m.get("supportedGenerationMethods", [])]
                        self.available_models = models
                        return models
                    return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π: {e}")
            return None

    async def _query_gemini(self, user_text):
        api_key = self.config["gemini_api_key"]
        model = self.config["gemini_model"]
        
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã URL –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        urls_to_try = [
            f"https://generativelanguage.googleapis.com/v1beta/{model}:generateContent?key={api_key}",
            f"https://generativelanguage.googleapis.com/v1/models/{model.replace('models/', '')}:generateContent?key={api_key}",
            f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={api_key}",
            f"https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key={api_key}"
        ]

        payload = {
            "contents": [{"parts": [{"text": user_text}]}],
            "system_instruction": {"parts": [{"text": self.config["system_prompt"]}]},
            "generationConfig": {"temperature": 0.7, "maxOutputTokens": 800}
        }

        headers = {"Content-Type": "application/json"}

        for url in urls_to_try:
            try:
                async with aiohttp.ClientSession() as session:
                    async with session.post(url, json=payload, headers=headers, timeout=15) as resp:
                        if resp.status == 200:
                            data = await resp.json()
                            try:
                                text = data["candidates"][0]["content"]["parts"][0]["text"]
                                return text.strip()
                            except:
                                return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç"
                        elif resp.status == 404:
                            continue  # –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π URL
                        else:
                            error = await resp.text()
                            return f"‚ùå –û—à–∏–±–∫–∞ {resp.status}"
            except Exception as e:
                continue

        return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Gemini. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á –∏ –º–æ–¥–µ–ª—å."

    async def on_unload(self):
        self.is_active = False
