# meta developer: @your_username
# scope: hikka_only

from .. import loader, utils
import asyncio
import time
import logging

logger = logging.getLogger(__name__)

@loader.tds
class PremiumPoster(loader.Module):
    """–ö—Ä–∞—Å–∏–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –ø—Ä–µ–º–∏—É–º —É—Å–ª—É–≥"""
    
    strings = {"name": "PremiumPoster"}
    
    def __init__(self):
        self.task = None
        self.is_running = False
        
        # –ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        self.message_text = """<b>üî• –ü–†–ï–ú–ò–£–ú –£–°–õ–£–ì–ò –ò –ê–ö–ö–ê–£–ù–¢–´ üî•</b>

<b>üí∞ –°–¢–û–ò–ú–û–°–¢–¨ –ù–ê –ü–ï–†–ò–û–î:</b>
‚îå 1 –º–µ—Å—è—Ü ‚Äî <code>150‚ÇΩ</code>
‚îú 3 –º–µ—Å—è—Ü–∞ ‚Äî <code>400‚ÇΩ</code>
‚îú 6 –º–µ—Å—è—Ü–µ–≤ ‚Äî <code>750‚ÇΩ</code>
‚îî 12 –º–µ—Å—è—Ü–µ–≤ ‚Äî <code>1400‚ÇΩ</code>

<b>üéØ –ù–ê–ö–†–£–¢–ö–ê –î–õ–Ø –í–°–ï–• –ü–õ–ê–¢–§–û–†–ú:</b>
‚îú Telegram
‚îú TikTok
‚îú –í–ö–æ–Ω—Ç–∞–∫—Ç–µ
‚îú Facebook
‚îî Instagram

<b>‚úÖ –£—Å–ª—É–≥–∏:</b>
‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã
‚Ä¢ –†–µ–∞–∫—Ü–∏–∏
‚Ä¢ –ü–æ–¥–ø–∏—Å—á–∏–∫–∏
‚Ä¢ –†–µ–ø–æ—Å—Ç—ã
‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—ã

<b>üì± TELEGRAM-–ê–ö–ö–ê–£–ù–¢–´ –í –ù–ê–õ–ò–ß–ò–ò:</b>

<b>üá∫üá∏ +1 –°–®–ê</b>
‚îå –ß–∏—Å—Ç—ã–π –∞–≤—Ç–æ—Ä–µ–≥
‚îú –ü—É—Å—Ç–æ–π
‚îî <code>80‚ÇΩ</code>

<b>üáßüá© +880 –ë–∞–Ω–≥–ª–∞–¥–µ—à</b>
‚îú –ê–≤—Ç–æ—Ä–µ–≥
‚îî <code>80‚ÇΩ</code>

<b>üá≤üá≤ +95 –ú—å—è–Ω–º–∞</b>
‚îú –ê–≤—Ç–æ—Ä–µ–≥
‚îî <code>80‚ÇΩ</code>

<b>üá∞üá™ +254 –ö–µ–Ω–∏—è</b>
‚îú –ê–≤—Ç–æ—Ä–µ–≥
‚îî <code>80‚ÇΩ</code>

<b>üìÖ –û—Ç–ª–µ–∂–∫–∞:</b> –æ—Ç 7 –¥–Ω–µ–π –¥–æ 6 –º–µ—Å—è—Ü–µ–≤

<b>üá∫üá∏ –°–¢–ê–†–´–ï –ê–ö–ö–ê–£–ù–¢–´ –°–®–ê:</b>
‚îå 2015 –≥–æ–¥ ‚Äî <code>950‚ÇΩ</code>
‚îú 2016 –≥–æ–¥ ‚Äî <code>750‚ÇΩ</code>
‚îú 2017 –≥–æ–¥ ‚Äî <code>520‚ÇΩ</code>
‚îî 2018 –≥–æ–¥ ‚Äî <code>450‚ÇΩ</code>

<b>üí≥ –ü–†–ò–ù–ò–ú–ê–Æ –û–ü–õ–ê–¢–£:</b>
‚Ä¢ ‚ÇΩ (–†—É–±–ª–∏)
‚Ä¢ TON
‚Ä¢ $
‚Ä¢ Gold –≤ Iris

<b>‚ö†Ô∏è –í–ê–ñ–ù–û:</b>
<i>–ó–∞ —Å–ª—ë—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–µ—Å—É</i>

<b>üì¨ –ö–æ–Ω—Ç–∞–∫—Ç:</b> @your_contact_here"""
        
        # –ß–∞—Ç—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
        self.target_chats = [
            "@GalaxyChat_Garants",
            "@garantferz", 
            "@loneasCHATIK",
            "@nft_chatp",
            "@chatsell_clix",
            "@syndicate_garant",
            "@VIP_GARANT_Chat",
            "@nft_chatiqs"
        ]
        
        self.chat_interval = 16
        self.full_cycle = 607
        self.current_index = 0
        self.message_count = 0
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
    
    @loader.command()
    async def pstart(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫—Ä–∞—Å–∏–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É"""
        if self.is_running:
            await utils.answer(message, "‚ö†Ô∏è –£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
            return
        
        self.is_running = True
        self.task = asyncio.create_task(self._beautiful_loop())
        
        await utils.answer(
            message,
            f"‚úÖ <b>–ö—Ä–∞—Å–∏–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!</b>\n"
            f"üì¢ –ß–∞—Ç–æ–≤: {len(self.target_chats)}\n"
            f"‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª: {self.chat_interval} —Å–µ–∫\n"
            f"üîÑ –¶–∏–∫–ª: {self.full_cycle} —Å–µ–∫"
        )
    
    @loader.command()
    async def pstop(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É"""
        if not self.is_running:
            await utils.answer(message, "üì≠ –ù–µ –∑–∞–ø—É—â–µ–Ω–∞")
            return
        
        self.is_running = False
        if self.task:
            self.task.cancel()
            self.task = None
        
        await utils.answer(message, "‚èπÔ∏è –†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
    
    @loader.command()
    async def ptest(self, message):
        """–¢–µ—Å—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è"""
        try:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å
            await utils.answer(message, self.message_text)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ø–µ—Ä–≤—ã–π —á–∞—Ç –¥–ª—è —Ç–µ—Å—Ç–∞
            if self.target_chats:
                await self.client.send_message(
                    self.target_chats[0],
                    self.message_text,
                    parse_mode='HTML'
                )
                await message.respond("‚úÖ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ø–µ—Ä–≤—ã–π —á–∞—Ç")
                
        except Exception as e:
            await utils.answer(message, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
    
    @loader.command()
    async def pstatus(self, message):
        """–°—Ç–∞—Ç—É—Å"""
        status = "üü¢ –†–∞–±–æ—Ç–∞–µ—Ç" if self.is_running else "üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
        
        info = f"<b>üìä –°—Ç–∞—Ç—É—Å PremiumPoster:</b>\n"
        info += f"<b>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</b> {status}\n"
        info += f"<b>üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</b> {self.message_count}\n"
        info += f"<b>üí¨ –ß–∞—Ç–æ–≤:</b> {len(self.target_chats)}\n"
        
        if self.is_running:
            current = self.target_chats[self.current_index % len(self.target_chats)]
            info += f"<b>‚è≥ –¢–µ–∫—É—â–∏–π —á–∞—Ç:</b> {current}"
        
        await utils.answer(message, info)
    
    async def _beautiful_loop(self):
        """–ö—Ä–∞—Å–∏–≤—ã–π —Ü–∏–∫–ª —Ä–∞—Å—Å—ã–ª–∫–∏"""
        while self.is_running:
            try:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ –≤—Å–µ —á–∞—Ç—ã
                for i, chat in enumerate(self.target_chats):
                    if not self.is_running:
                        break
                    
                    self.current_index = i
                    
                    try:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        await self.client.send_message(
                            chat,
                            self.message_text,
                            parse_mode='HTML'  # –í–∞–∂–Ω–æ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        )
                        
                        self.message_count += 1
                        logger.info(f"–ö—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {chat}")
                        
                        # –ñ–¥–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
                        if i < len(self.target_chats) - 1:
                            for _ in range(self.chat_interval):
                                if not self.is_running:
                                    break
                                await asyncio.sleep(1)
                        
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –≤ {chat}: {e}")
                        await asyncio.sleep(5)
                
                # –ñ–¥–µ–º –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª
                if self.is_running:
                    logger.info(f"–¶–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω, –∂–¥–µ–º {self.full_cycle} —Å–µ–∫")
                    for _ in range(self.full_cycle):
                        if not self.is_running:
                            break
                        await asyncio.sleep(1)
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —Ü–∏–∫–ª–∞: {e}")
                await asyncio.sleep(30)
    
    async def on_unload(self):
        self.is_running = False
        if self.task:
            self.task.cancel()
