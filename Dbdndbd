# meta developer: @your_username (–∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π)
# meta pic: https://img.icons8.com/color/48/000000/artificial-intelligence.png
# scope: hikka_only
# scope: hikka_min 1.6.0

import asyncio
import aiohttp
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class GeminiChatMod(loader.Module):
    """–û–±—â–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —á–µ—Ä–µ–∑ Gemini AI"""

    strings = {
        "name": "GeminiChat",
        "no_api_key": "üö´ <b>API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!</b>\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>.gkey <–≤–∞—à_–∫–ª—é—á></code> –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.",
        "config_done": "‚úÖ <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.</b>\n–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –∫–æ–º–∞–Ω–¥–æ–π <code>.gstart</code>.",
        "already_on": "‚ö†Ô∏è <b>–†–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å {} —É–∂–µ –≤–∫–ª—é—á–µ–Ω.</b>",
        "already_off": "‚ö†Ô∏è <b>–†–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω.</b>",
        "started": "ü§ñ <b>–†–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å Gemini –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¥–ª—è {}</b>\n–¢–µ–ø–µ—Ä—å —è –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.",
        "stopped": "‚èπÔ∏è <b>–†–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω.</b>",
        "status_on": "üü¢ <b>–°—Ç–∞—Ç—É—Å:</b> –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è {}",
        "status_off": "üî¥ <b>–°—Ç–∞—Ç—É—Å:</b> –ù–µ –∞–∫—Ç–∏–≤–µ–Ω",
        "waiting": "ü§î <b>Gemini –¥—É–º–∞–µ—Ç...</b>",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞ Gemini:</b> {}",
        "thinking": "üß† <b>–ó–∞–ø—Ä–æ—Å –∫ Gemini:</b>\n{}",
        "response": "üí¨ <b>–û—Ç–≤–µ—Ç –¥–ª—è {}:</b>\n{}",
        "help": (
            "ü§ñ <b>–ü–æ–º–æ—â—å –ø–æ –º–æ–¥—É–ª—é GeminiChat</b>\n\n"
            "1. <b>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ API –∫–ª—é—á–∞:</b>\n"
            "   <code>.gkey AIzaSy..._–≤–∞—à_–∫–ª—é—á</code>\n\n"
            "2. <b>–ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞:</b>\n"
            "   <code>.gstart</code> ‚Äî –Ω–∞—á–∞—Ç—å –æ—Ç–≤–µ—á–∞—Ç—å @rostovskiy7777\n"
            "   <code>.gstop</code> ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å\n\n"
            "3. <b>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:</b>\n"
            "   <code>.gstatus</code>\n\n"
            "4. <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏:</b>\n"
            "   <code>.gmodel <–Ω–∞–∑–≤–∞–Ω–∏–µ_–º–æ–¥–µ–ª–∏></code>\n"
            "   (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: gemini-1.5-flash-latest)\n\n"
            "5. <b>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å:</b>\n"
            "   –û—Ç–≤–µ—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–≤–µ–¥–∏ <code>.g</code>\n"
            "   (—Å—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω)"
        )
    }

    def __init__(self):
        self.target_user = "@rostovskiy7777"
        self.config = loader.ModuleConfig(
            loader.ConfigValue(
                "gemini_api_key",
                None,
                "API –∫–ª—é—á Google Gemini (–ø–æ–ª—É—á–∏—Ç—å: https://aistudio.google.com/app/apikey)",
                validator=loader.validators.String()
            ),
            loader.ConfigValue(
                "gemini_model",
                "gemini-1.5-flash-latest",
                "–ú–æ–¥–µ–ª—å Gemini (–Ω–∞–ø—Ä–∏–º–µ—Ä: gemini-pro, gemini-1.5-flash-latest)",
                validator=loader.validators.String()
            ),
            loader.ConfigValue(
                "system_prompt",
                "–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.",
                "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏",
                validator=loader.validators.String()
            )
        )
        self.is_active = False
        self.user_id = None

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ watcher
            entity = await client.get_entity(self.target_user)
            self.user_id = entity.id
            logger.info(f"–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {self.target_user} —Å ID {self.user_id}")
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {self.target_user}: {e}")
            self.user_id = None

    # --- –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---

    @loader.command(ru_doc="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å API –∫–ª—é—á Gemini")
    async def gkeycmd(self, message):
        """<–∫–ª—é—á> - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å API –∫–ª—é—á"""
        key = utils.get_args_raw(message)
        if not key:
            await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á. –ü—Ä–∏–º–µ—Ä: .gkey AIzaSy...")
            return
        self.config["gemini_api_key"] = key
        await utils.answer(message, self.strings("config_done"))

    @loader.command(ru_doc="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å Gemini")
    async def gmodelcmd(self, message):
        """<–º–æ–¥–µ–ª—å> - –í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å (–ø–æ —É–º–æ–ª—á. gemini-1.5-flash-latest)"""
        model = utils.get_args_raw(message)
        if not model:
            await utils.answer(message, f"üìù –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å: {self.config['gemini_model']}")
            return
        self.config["gemini_model"] = model
        await utils.answer(message, f"‚úÖ –ú–æ–¥–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: {model}")

    @loader.command(ru_doc="–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ-–æ—Ç–≤–µ—Ç –¥–ª—è @rostovskiy7777")
    async def gstartcmd(self, message):
        """–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è"""
        if self.is_active:
            await utils.answer(message, self.strings("already_on").format(self.target_user))
            return
        if not self.config["gemini_api_key"]:
            await utils.answer(message, self.strings("no_api_key"))
            return
        self.is_active = True
        await utils.answer(message, self.strings("started").format(self.target_user))

    @loader.command(ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ-–æ—Ç–≤–µ—Ç")
    async def gstopcmd(self, message):
        """–í—ã–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è"""
        if not self.is_active:
            await utils.answer(message, self.strings("already_off"))
            return
        self.is_active = False
        await utils.answer(message, self.strings("stopped"))

    @loader.command(ru_doc="–°—Ç–∞—Ç—É—Å –º–æ–¥—É–ª—è")
    async def gstatuscmd(self, message):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"""
        if self.is_active and self.user_id:
            status = self.strings("status_on").format(self.target_user)
        elif self.is_active and not self.user_id:
            status = f"üü° <b>–°—Ç–∞—Ç—É—Å:</b> –ê–∫—Ç–∏–≤–µ–Ω, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {self.target_user} –Ω–µ –Ω–∞–π–¥–µ–Ω."
        else:
            status = self.strings("status_off")
        await utils.answer(
            message,
            f"{status}\nü§ñ <b>–ú–æ–¥–µ–ª—å:</b> {self.config['gemini_model']}\nüîë <b>API –∫–ª—é—á:</b> {'‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if self.config['gemini_api_key'] else '‚ùå –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}"
        )

    @loader.command(ru_doc="–ü–æ–º–æ—â—å –ø–æ –º–æ–¥—É–ª—é")
    async def ghelpcmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"""
        await utils.answer(message, self.strings("help"))

    @loader.command(ru_doc="–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Gemini")
    async def gcmd(self, message):
        """–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Ä–µ–ø–ª–∞–π —á–µ—Ä–µ–∑ Gemini (—Ä–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å)"""
        reply = await message.get_reply_message()
        if not reply:
            await utils.answer(message, "‚ùå –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            return

        user_text = reply.raw_text
        if not user_text:
            await utils.answer(message, "‚ùå –í —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞.")
            return

        thinking_msg = await utils.answer(message, self.strings("waiting"))
        response = await self._query_gemini(user_text)

        if response.startswith("‚ùå"):
            await thinking_msg.edit(response)
        else:
            await thinking_msg.edit(
                self.strings("response").format(
                    f"@{reply.sender.username}" if reply.sender.username else "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é",
                    response
                )
            )

    # --- Watcher –∏ –º–µ—Ç–æ–¥—ã API ---

    async def watcher(self, message):
        """–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –≤—Ö–æ–¥—è—â–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        if not self.is_active:
            return
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
        if not self.config["gemini_api_key"]:
            return
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —ç—Ç–æ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if not message.is_private:
            return
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω—É–∂–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if message.sender_id != self.user_id:
            return
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        if message.out:
            return
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if not message.raw_text:
            return

        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {self.target_user}: {message.raw_text[:50]}...")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º "–¥—É–º–∞–µ—Ç"
        thinking_msg = await message.reply(self.strings("waiting"))

        # –ó–∞–ø—Ä–æ—Å –∫ Gemini
        response = await self._query_gemini(message.raw_text)

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç–æ–º
        if response.startswith("‚ùå"):
            await thinking_msg.edit(response)
        else:
            await thinking_msg.edit(response)

    async def _query_gemini(self, user_text):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Gemini API –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç"""
        api_key = self.config["gemini_api_key"]
        model = self.config["gemini_model"]
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={api_key}"

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
        payload = {
            "contents": [
                {
                    "parts": [{"text": user_text}]
                }
            ],
            "system_instruction": {
                "parts": [{"text": self.config["system_prompt"]}]
            },
            "generationConfig": {
                "temperature": 0.7,
                "maxOutputTokens": 800,
            }
        }

        headers = {
            "Content-Type": "application/json"
        }

        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(url, json=payload, headers=headers, timeout=30) as resp:
                    if resp.status != 200:
                        error_text = await resp.text()
                        logger.error(f"Gemini API error {resp.status}: {error_text}")
                        return f"‚ùå –û—à–∏–±–∫–∞ API {resp.status}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á –∏ –º–æ–¥–µ–ª—å."

                    data = await resp.json()

                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                    try:
                        candidates = data.get("candidates", [])
                        if not candidates:
                            return "‚ùå –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ–ª–∏."

                        parts = candidates[0].get("content", {}).get("parts", [])
                        if not parts:
                            return "‚ùå –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏."

                        response_text = parts[0].get("text", "").strip()
                        if not response_text:
                            return "‚ùå –ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç."

                        return response_text

                    except (KeyError, IndexError, AttributeError) as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ Gemini: {e}")
                        return f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞: {data}"

        except asyncio.TimeoutError:
            logger.error("–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Gemini")
            return "‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        except aiohttp.ClientError as e:
            logger.error(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: {e}")
            return f"‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: {e}"
        except Exception as e:
            logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
            return f"‚ùå –û—à–∏–±–∫–∞: {e}"

    async def on_unload(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ"""
        self.is_active = False
